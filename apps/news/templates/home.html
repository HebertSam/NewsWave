{% extends "base.html" %}
{% block content %}
<style>
    .stories{
        margin-left:auto;
        margin-right:auto;
        overflow-x: scroll;
        max-width:1000px;
        max-height:400px;
        display:flex;
        flex-direction: row;
    }
    .story{
        display:inline-block;
        max-width:400px;
        height:400x;
        border: 2px solid black;
        vertical-align: top;
    }
    .story img{
        max-width:380px;
        max-height:380px;
    }
</style>
<script>
$(document).ready(function(){
    var outlets = $(".outlet");
    // part 1: populate outlet rows with articles
    for(let i = 0; i < outlets.length; i++){
        var sourceId = outlets[i].id;
        (function(sourceId){
            $.ajax({
                url: "https://newsapi.org/v1/articles?source=" + sourceId + "&apiKey=4d48612e30ef4e4f8a55c0d6e6f984ef",
                method: "GET"
            })
            .done(function(source){
                var stories = source.articles;
                var parentNode = $("#" + sourceId);
                var len = stories.length;
                if(len > 10){
                    len = 10;
                }
                for(let j = 0; j < len; j++){
                    var story = stories[j];
                    var titleString = "<a href='" + story.url + "'>" + story.title + "</a><br />";
                    var imgString = "<img src='" + story.urlToImage + "'/><br />";
                    var descString = "<p>" + story.description + "</p>";
                    var formString = "<form action='/add_story' method='post' class='storyForm'>{% csrf_token %}<input type='hidden' name='url' value='" + story.url + "'/><input type='hidden' name='title' value='" + story.title + "'/><input type='submit' class='story_submit' value='Add to reading list'></form>";
                    parentNode.append("<div class='story'>" + titleString + imgString + descString + formString + "</div>");
                }           
            });
        }(sourceId));
    }

    // part 2: add stories to reading list
    $(document).on('submit', '.storyForm', function(e){
        e.preventDefault();
        $.ajax({
            url: $(this).attr('action'),
            method: 'post',
            data: $(this).serialize()
        });
        $(this).hide();
    });
});
</script>

    {% if locations %}
        {% for location in locations %}
            <div class="location"></div>
        {% endfor %}
    {% endif %}
    {% if outlets %}
        {% for outlet in outlets %}
            <div class="outlet" id="{{outlet.sourceId}}">
                <h2>{{outlet.sourceName}}</h2>
                <div class="stories"></div>
            </div>
        {% endfor %}
    {% endif %}
    {% if notes %}
        {% for notes in notes %}
            <div class="note"></div>
        {% endfor %}
    {% endif %}
{% endblock content %}